name: Microsoft AI Foundry Control

on:
  workflow_dispatch: # Esto permite la ejecuci√≥n manual con formulario
    inputs:
      action_type:
        description: '¬øQu√© quieres hacer?'
        required: true
        default: 'listar'
        type: choice
        options:
          - crear
          - listar
          - preguntar
      agent_name:
        description: 'Nombre del agente (solo para crear)'
        required: false
      instructions:
        description: 'Instrucciones del agente (solo para crear)'
        required: false
      file_path:
        description: 'File Path del Archivo Tools (solo para crear)'
        required: false
      agent_id:
        description: 'ID del agente (solo para preguntar)'
        required: false
      prompt_text:
        description: 'Tu mensaje para el agente (solo para preguntar)'
        required: false


jobs:
  execute-api-action:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar Dependencias
        run: pip install -r requirements.txt

      - name: Iniciar Backend FastAPI
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_AI_FOUNDRY_ENDPOINT: ${{ secrets.AZURE_AI_FOUNDRY_ENDPOINT }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_BASE_URL: ${{ secrets.LANGFUSE_BASE_URL }}
          MODEL_DEPLOYMENT_NAME: "gpt-4.1-mini"
        run: |
          python -m uvicorn app:app --host 0.0.0.0 --port 8000 &
          sleep 12 # Tiempo para que el backend conecte con Azure
      
      - name: Ejecutar Listar Agents
        if: github.event.inputs.action_type == 'listar'
        run: |
          echo "üìã Listando agentes..."
          curl -s http://localhost:8000/list-agents | jq .
          
          echo "‚è≥ Sincronizando trazas con Langfuse..."
          sleep 5

      - name: Ejecutar Creacion
        if: github.event.inputs.action_type == 'crear'
        run: |
          echo "üõ†Ô∏è Creando agente: ${{ github.event.inputs.agent_name }}"
          
          FILE_NAME="${{ github.event.inputs.file_path }}"
          
          if [ -z "$FILE_NAME" ]; then
              # Caso sin archivo
              curl -s -X POST http://localhost:8000/agents \
                -F "name=${{ github.event.inputs.agent_name }}" \
                -F "instructions=${{ github.event.inputs.instructions }}" | jq .
          else
              # Caso con archivo dentro de /upload
              FULL_PATH="./upload/$FILE_NAME"
              if [ -f "$FULL_PATH" ]; then
                  echo "üìÅ Archivo encontrado: $FULL_PATH"
                  RESPONSE=$(curl -s -X POST http://localhost:8000/agents \
                    -F "name=${{ github.event.inputs.agent_name }}" \
                    -F "instructions=${{ github.event.inputs.instructions }}" \
                    -F "file=@$FULL_PATH")
                  
                  echo "$RESPONSE" | jq .
                  
                  # Si la respuesta es exitosa (contiene id), marcamos para borrar
                  if echo "$RESPONSE" | grep -q "id"; then
                    echo "DELETE_FROM_REPO=true" >> $GITHUB_ENV
                    echo "FILE_TO_DELETE=$FULL_PATH" >> $GITHUB_ENV
                  fi
              else
                  echo "‚ùå Error: El archivo $FULL_PATH no existe en la carpeta upload/."
                  exit 1
              fi
          fi
          
          echo "‚è≥ Sincronizando trazas con Langfuse..."
          sleep 5

      - name: Ejecutar Conversacion Agent Id
        if: github.event.inputs.action_type == 'preguntar'
        run: |
          echo "üí¨ Enviando prompt a: ${{ github.event.inputs.agent_id }}"
          curl -s -X POST "http://localhost:8000/agents/${{ github.event.inputs.agent_id }}/prompt" \
            -H "Content-Type: application/json" \
            -d '{"prompt": "${{ github.event.inputs.prompt_text }}"}' | jq .

          echo "‚è≥ Sincronizando trazas con Langfuse..."
          sleep 10

      - name: Limpiar Archivo del Repositorio Real
        if: env.DELETE_FROM_REPO == 'true'
        run: |
          echo "üßπ Iniciando limpieza en el repositorio..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # El archivo debe eliminarse de git
          git rm "${{ env.FILE_TO_DELETE }}"
          git commit -m "cleanup: eliminar archivo procesado ${{ env.FILE_TO_DELETE }}"
          git push origin ${{ github.ref_name }}
          echo "‚úÖ Archivo eliminado del repositorio permanentemente."