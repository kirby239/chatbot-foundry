name: Microsoft AI Foundry Control

on:
  workflow_dispatch: # Esto permite la ejecuci√≥n manual con formulario
    inputs:
      action_type:
        description: '¬øQu√© quieres hacer?'
        required: true
        default: 'listar'
        type: choice
        options:
          - crear
          - listar
          - preguntar
      agent_name:
        description: 'Nombre del agente (solo para crear)'
        required: false
      instructions:
        description: 'Instrucciones del agente (solo para crear)'
        required: false
      file_path:
        description: 'File Path del Archivo Tools (solo para crear)'
        required: false
      agent_id:
        description: 'ID del agente (solo para preguntar)'
        required: false
      prompt_text:
        description: 'Tu mensaje para el agente (solo para preguntar)'
        required: false


jobs:
  execute-api-action:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar Dependencias
        run: pip install -r requirements.txt

      - name: Iniciar Backend FastAPI
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_AI_FOUNDRY_ENDPOINT: ${{ secrets.AZURE_AI_FOUNDRY_ENDPOINT }}
          LANGFUSE_PUBLIC_KEY: ${{ secrets.LANGFUSE_PUBLIC_KEY }}
          LANGFUSE_SECRET_KEY: ${{ secrets.LANGFUSE_SECRET_KEY }}
          LANGFUSE_BASE_URL: ${{ secrets.LANGFUSE_BASE_URL }}
          MODEL_DEPLOYMENT_NAME: "gpt-4.1-mini"
        run: |
          python -m uvicorn app:app --host 0.0.0.0 --port 8000 &
          sleep 10 # Tiempo para que el backend conecte con Azure

      - name: Ejecutar Acci√≥n Seleccionada
        run: |
          ACTION="${{ github.event.inputs.action_type }}"
          
          if [ "$ACTION" == "crear" ]; then
            echo "üõ†Ô∏è Creando agente: ${{ github.event.inputs.agent_name }}"

            # Usamos -F (form-data) en lugar de -d (json)
            curl -s -X POST http://localhost:8000/agents \
              -F "name=${{ github.event.inputs.agent_name }}" \
              -F "instructions=${{ github.event.inputs.instructions }}" \
              -F "file=@${{ github.event.inputs.file_path }}" | jq .
              
          elif [ "$ACTION" == "listar" ]; then
            echo "üìã Listando agentes..."
            curl -s http://localhost:8000/list-agents | jq .

          elif [ "$ACTION" == "preguntar" ]; then
            echo "üí¨ Enviando prompt a: ${{ github.event.inputs.agent_id }}"
            curl -s -X POST "http://localhost:8000/agents/${{ github.event.inputs.agent_id }}/prompt" \
              -H "Content-Type: application/json" \
              -d '{"prompt": "${{ github.event.inputs.prompt_text }}"}' | jq .
          fi

          echo "‚è≥ Sincronizando trazas con Langfuse..."
          sleep 10