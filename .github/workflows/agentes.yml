name: Microsoft AI Foundry Control

on:
  workflow_dispatch: # Esto permite la ejecución manual con formulario
    inputs:
      action_type:
        description: '¿Qué quieres hacer?'
        required: true
        default: 'listar'
        type: choice
        options:
          - crear
          - listar
          - preguntar
      agent_name:
        description: 'Nombre del agente (solo para crear)'
        required: false
      prompt_text:
        description: 'Tu mensaje para el agente (solo para preguntar)'
        required: false
      agent_id:
        description: 'ID del agente (solo para preguntar)'
        required: false

jobs:
  execute-api-action:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar Dependencias
        run: pip install -r requirements.txt

      - name: Iniciar Backend FastAPI
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_AI_FOUNDRY_ENDPOINT: ${{ secrets.AZURE_AI_FOUNDRY_ENDPOINT }}
          MODEL_DEPLOYMENT_NAME: "gpt-4o-mini"
        run: |
          python -m uvicorn app:app --host 0.0.0.0 --port 8000 &
          sleep 10 # Tiempo para que el backend conecte con Azure

      - name: Ejecutar Acción Seleccionada
        run: |
          ACTION="${{ github.event.inputs.action_type }}"
          
          if [ "$ACTION" == "crear" ]; then
            echo "Creando agente: ${{ github.event.inputs.agent_name }}"
            curl -s -X POST http://localhost:8000/agents \
              -H "Content-Type: application/json" \
              -d '{"name": "${{ github.event.inputs.agent_name }}", "instructions": "Eres un asistente útil"}' | jq .

          elif [ "$ACTION" == "listar" ]; then
            echo "Listando agentes..."
            curl -s http://localhost:8000/agents | jq .

          elif [ "$ACTION" == "preguntar" ]; then
            echo "Enviando prompt a: ${{ github.event.inputs.agent_id }}"
            curl -s -X POST "http://localhost:8000/agents/${{ github.event.inputs.agent_id }}/prompt" \
              -H "Content-Type: application/json" \
              -d '{"prompt": "${{ github.event.inputs.prompt_text }}"}' | jq .
          fi